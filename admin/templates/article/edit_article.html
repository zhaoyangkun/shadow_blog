<!--_meta ä½œä¸ºå…¬å…±æ¨¡ç‰ˆåˆ†ç¦»å‡ºå»-->
{% load staticfiles %}
{% url 'article' as article_api %}
<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <!--[if lt IE 9]>
    <script type="text/javascript" src="lib/html5shiv.js"></script>
    <script type="text/javascript" src="lib/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}H-ui-admin/static/h-ui/css/H-ui.min.css"/>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}H-ui-admin/static/h-ui.admin/css/H-ui.admin.css"/>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}H-ui-admin/lib/Hui-iconfont/1.0.8/iconfont.css"/>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}H-ui-admin/static/h-ui.admin/skin/default/skin.css"
          id="skin"/>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}H-ui-admin/static/h-ui.admin/css/style.css"/>
    <link rel="stylesheet" href="{{ STATIC_URL }}vditor/css/vditor.classic.css"/>
    <link rel="shortcut icon" href="{{ STATIC_URL }}img/favicon.ico"/>
    <!--[if IE 6]>
    <script type="text/javascript" src="lib/DD_belatedPNG_0.0.8a-min.js" ></script>
    <script>DD_belatedPNG.fix('*');</script>
    <![endif]-->
    <!--/meta ä½œä¸ºå…¬å…±æ¨¡ç‰ˆåˆ†ç¦»å‡ºå»-->
    <title>ä¿®æ”¹æ–‡ç« </title>
    <meta name="keywords" content="H-ui.admin v3.1,H-uiç½‘ç«™åå°æ¨¡ç‰ˆ,åå°æ¨¡ç‰ˆä¸‹è½½,åå°ç®¡ç†ç³»ç»Ÿæ¨¡ç‰ˆ,HTMLåå°æ¨¡ç‰ˆä¸‹è½½">
    <meta name="description" content="H-ui.admin v3.1ï¼Œæ˜¯ä¸€æ¬¾ç”±å›½äººå¼€å‘çš„è½»é‡çº§æ‰å¹³åŒ–ç½‘ç«™åå°æ¨¡æ¿ï¼Œå®Œå…¨å…è´¹å¼€æºçš„ç½‘ç«™åå°ç®¡ç†ç³»ç»Ÿæ¨¡ç‰ˆï¼Œé€‚åˆä¸­å°å‹CMSåå°ç³»ç»Ÿã€‚">
</head>
<body>
<article class="page-container">
    <form action="" method="post" class="form form-horizontal" id="form-change-password" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" value="{{ request.session.user_id }}" name="user_id" id="user_id">
        <input hidden value="{{ article.id }}" name="id" id="article_id">
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>æ–‡ç« æ ‡é¢˜ï¼š</label>
            <div class="formControls col-xs-8 col-sm-9">
                <label for="newpassword"></label>
                <input type="text" class="input-text" autocomplete="off" placeholder="æ–‡ç« æ ‡é¢˜" name="title"
                       value="{{ article.title }}"
                       id="title">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>åˆ†ç±»ï¼š</label>
            <div class="formControls col-xs-8 col-sm-9">
                <label for="parent"></label>
                <select name="parent_id" id="parent_sort">
                    <option value="">åˆ†ç±»</option>
                    {% for parent in parent_sorts %}
                        {% if parent.id == article.category.parent_id %}
                            <option value="{{ parent.id }}" selected>{{ parent.category_name }}</option>
                        {% else %}
                            <option value="{{ parent.id }}">{{ parent.category_name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>æ ‡ç­¾å¢™ï¼š</label>
            <div class="formControls col-xs-8 col-sm-9">
                <label for="category"></label>
                <select name="category_id" id="child_sort">
                    <option value="">æ ‡ç­¾å¢™</option>
                    {% for child in child_sorts %}
                        {% if child.id == article.category.id and child.parent_id == article.category.parent_id %}
                            <option value="{{ child.id }}" selected>{{ child.category_name }}</option>
                        {% elif child.id != article.category.id and child.parent_id == article.category.parent_id %}
                            <option value="{{ child.id }}">{{ child.category_name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>æ˜¯å¦åŠ å…¥çŒœä½ å–œæ¬¢ï¼š</label>
            <div class="formControls col-xs-8 col-sm-9">
                <label for="is_like"></label>
                <select name="is_like" id="is_like">
                    <option value="" selected>æ˜¯å¦åŠ å…¥çŒœä½ å–œæ¬¢</option>
                    {% if article.is_like == 1 %}
                        <option value="1" selected>æ˜¯</option>
                        <option value="0">å¦</option>
                    {% endif %}
                    {% if article.is_like == 0 %}
                        <option value="1">æ˜¯</option>
                        <option value="0" selected>å¦</option>
                    {% endif %}
                </select>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>å‘å¸ƒçŠ¶æ€ï¼š</label>
            <div class="formControls col-xs-8 col-sm-9">
                <label for="is_show"></label>
                <select name="is_show" id="is_show">
                    <option value="" selected>å‘å¸ƒçŠ¶æ€</option>
                    {% if article.is_show == 1 %}
                        <option value="1" selected>å·²å‘å¸ƒ</option>
                        <option value="0">æœªå‘å¸ƒ</option>
                    {% endif %}
                    {% if article.is_show == 0 %}
                        <option value="1">å·²å‘å¸ƒ</option>
                        <option value="0" selected>æœªå‘å¸ƒ</option>
                    {% endif %}
                </select>
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2">å›¾ç‰‡ï¼š</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="file" name="img" id="img">
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"></label>
            <div class="formControls col-xs-8 col-sm-9">
                <img id="img_show" style="max-height: 135px; max-width: 240px" src="{{ MEDIA_URL }}{{ article.img }}"
                     alt="">
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2">æ–‡ç« å†…å®¹ï¼š</label>
            <div class="formControls col-xs-8 col-sm-9">
                <textarea hidden id="article-content">{{ article.content }}</textarea>
                <div id="vditor"></div>
                {% comment %}                {{ form.media }}
                {% for field in form %}
                    {{ field }}
                {% endfor %}{% endcomment %}
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"></label>
            <div class="formControls col-xs-8 col-sm-9">
                <input class="btn btn-primary radius" type="submit" value="&nbsp;&nbsp;ä¿å­˜&nbsp;&nbsp;">
            </div>
        </div>
    </form>
</article>

<!--_footer ä½œä¸ºå…¬å…±æ¨¡ç‰ˆåˆ†ç¦»å‡ºå»-->
<script type="text/javascript" src="{{ STATIC_URL }}H-ui-admin/lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}H-ui-admin/lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}H-ui-admin/static/h-ui/js/H-ui.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}H-ui-admin/static/h-ui.admin/js/H-ui.admin.js"></script>
<!--/_footer /ä½œä¸ºå…¬å…±æ¨¡ç‰ˆåˆ†ç¦»å‡ºå»-->
<!--è¯·åœ¨ä¸‹æ–¹å†™æ­¤é¡µé¢ä¸šåŠ¡ç›¸å…³çš„è„šæœ¬-->
<script type="text/javascript"
        src="{{ STATIC_URL }}H-ui-admin/lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript"
        src="{{ STATIC_URL }}H-ui-admin/lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}H-ui-admin/lib/jquery.validation/1.14.0/messages_zh.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}vditor/js/vditor.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/compress.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/global.js"></script>
<script type="text/javascript">
    $(function () {
        {#initParentSorts();#}

        //åˆå§‹åŒ–markdownç¼–è¾‘å™¨çš„å†…å®¹
        vditor.setValue($("#article-content").val()); //æ’å…¥å†…å®¹

        $("#form-change-password").validate({
            ignore: ":hidden:not(select)",//è§£å†³æ— æ³•æ ¡éªŒselect
            rules: {
                title: {
                    required: true,
                    minlength: 1,
                    maxlength: 50
                },
                parent_id: {
                    required: true,
                },
                category_id: {
                    required: true,
                },
                is_like: {
                    required: true,
                },
                is_show: {
                    required: true,
                },
            },
            messages: {},
            {#onkeyup: false,#}
            {#focusCleanup: true,#}
            success: "valid",
            submitHandler: function (form) {
                if (!fileIsNone()) {
                    if (!checkType()) {
                        layer.msg("è¯·ä¸Šä¼ å›¾ç‰‡ï¼");
                        return;
                    }
                    if (!checkImgSize()) {
                        layer.msg("ä¸Šä¼ å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡1Mï¼");
                        return;
                    }
                }
                let formData = new FormData($('#form-change-password')[0]);
                formData.append('content', vditor.getValue());
                {% comment %}if (fileIsNone()) {
                    submitForm(formData);
                    return;
                }{% endcomment %}
                submitForm(formData);
            }
        });
    });

    function submitForm(formData) {
        $.ajax({
            type: 'PATCH',
            url: '{{ article_api }}',
            data: formData,
            processData: false,// ä¸å¤„ç†æ•°æ®
            contentType: false, // ä¸è®¾ç½®å†…å®¹ç±»å‹
            success: function (data) {
                if (data.code === 1) {
                    layer.msg(data.msg, {icon: 6, time: 1000}, function () {
                        vditor.clearCache();
                        layer.close(layer.index);
                        window.parent.location.reload();
                    });
                } else if (data.code === 0) {
                    layer.msg(data.msg.content[0], {icon: 5, time: 1000});
                }
            },
            error: function (data) {
                console.log(data);
            }
        });
    }

    /*ç”Ÿæˆæ¬¡çº§åˆ†ç±»option*/
    $("#parent_sort").change(function () {
        if ($("#parent_sort option:selected").val() !== "") {
            let parent_id = $("#parent_sort option:selected").val();
            $("#child_sort").empty();
            $("#child_sort").html('<option value="" selected>æ ‡ç­¾å¢™</option>');
            $.getJSON(
                "{% url 'getChildSorts' %}",
                {"parent_id": parent_id},
                function (data) {
                    /*dataè¡¨ç¤ºéå†å¯¹è±¡ï¼Œiè¡¨ç¤ºæ•°ç»„ä¸‹æ ‡ï¼Œvalè¡¨ç¤ºä¸‹æ ‡å¯¹åº”çš„å€¼*/
                    $.each(data, function (i, val) {
                        $("#child_sort").append('<option value="' + val.id + '">'
                            + val.category_name + '</option>');
                    });
                }
            );
        } else {
            $("#child_sort").empty();
            $("#child_sort").html('<option value="" selected>å…·ä½“ç±»å‹</option>');
        }
    });

    //åˆ é™¤
    function item_del(obj, id) {
        layer.confirm('ç¡®è®¤è¦åˆ é™¤å—ï¼Ÿ', function (index) {
            $.ajax({
                url: "{{ article_api }}",
                type: 'DELETE',
                headers: {'X-CSRFToken': getCsrfToken()},
                data: {"id": id},
                success: function (data) {
                    if (data.code === 1) {
                        layer.msg(data.msg, {icon: 6, time: 1000}, function () {
                            location.reload();
                        });
                    } else if (data.code === 0) {
                        layer.msg(data.msg, {icon: 5, time: 1000});
                    }
                },
                error: function (data) {
                    console.log(data);
                }
            });
        });
    }

    function fileIsNone() {
        let fileName = document.getElementById("img").value;
        return fileName === "" || fileName == null;
    }

    function checkType() {
        //å¾—åˆ°ä¸Šä¼ æ–‡ä»¶çš„å€¼
        let fileName = document.getElementById("img").value;
        //è¿”å›Stringå¯¹è±¡ä¸­å­å­—ç¬¦ä¸²æœ€åå‡ºç°çš„ä½ç½®.
        let seat = fileName.lastIndexOf(".");
        //è¿”å›ä½äºStringå¯¹è±¡ä¸­æŒ‡å®šä½ç½®çš„å­å­—ç¬¦ä¸²å¹¶è½¬æ¢ä¸ºå°å†™.
        let extension = fileName.substring(seat).toLowerCase();
        //åˆ¤æ–­å…è®¸ä¸Šä¼ çš„æ–‡ä»¶æ ¼å¼
        let allowed = [".jpg", ".gif", ".png", ".jpeg"];
        for (let i = 0; i < allowed.length; i++) {
            if (!(allowed[i] !== extension)) {
                return 1;
            }
        }
        return 0;
    }

    function checkImgSize() {
        let file = document.getElementById("img");
        return (file.files[0].size) / 1024 <= 1024;
    }

    //åˆå§‹åŒ–vditor
    const vditor = new Vditor('vditor', {
        counter: 100000,
        height: 300,
        editorName: 'vditor',
        tab: '\t',
        toolbar: ['emoji',
            'headings', 'bold', 'italic', 'strike', '|',
            'line', 'quote', 'list', 'ordered-list', 'check', 'code',
            'inline-code', 'undo', 'redo', 'upload',
            'link', 'table', 'record',
            'both', 'preview', 'fullscreen', 'info', 'help', 'br'],
        upload: {
            accept: '.jpg,.png,.gif,.jpeg',
            filename(name) {
                return name.replace(/\?|\\|\/|:|\||<|>|\*|\[|\]|\s+/g, '-')
            },
            //è‡ªå®šä¹‰ä¸Šä¼ å›¾ç‰‡
            handler(file) {
                let formData = new FormData(), flag = 1;
                file.forEach(f => {
                    if (f.size / 1024 > 1024) { //æ ¡éªŒå›¾ç‰‡å¤§å°
                        layer.msg("ä¸Šä¼ å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡1M");
                        flag = 0;
                        return;
                    }
                    formData.append('files', f, f.name);
                });
                if (flag === 1) {
                    upload_img(formData);
                }
            },
        },
        preview: {
            show: true,
            parse: () => {
                LazyLoadImage();
            },
        },
        hint: {
            emoji: {
                "pray": "ğŸ™",
                "broken_heart": "ğŸ’”",
                "ok_hand": "ğŸ‘Œ",
                "smile": "ğŸ˜„",
                "laughing": "ğŸ˜†",
                "smirk": "ğŸ˜",
                "heart_eyes": "ğŸ˜",
                "grin": "ğŸ˜",
                "stuck_out_tongue": "ğŸ˜›",
                "expressionless": "ğŸ˜‘",
                "unamused": "ğŸ˜’",
                "sob": "ğŸ˜­",
                "joy": "ğŸ˜‚",
                "tired_face": "ğŸ˜«",
                "blush": "ğŸ˜Š",
                "cry": "ğŸ˜¢",
                "fearful": "ğŸ˜¨",
            }
        }
    });

    const LazyLoadImage = () => {
        const loadImg = (it) => {
            const testImage = document.createElement('img');
            testImage.src = it.getAttribute('data-src');
            testImage.addEventListener('load', () => {
                it.src = testImage.src;
                it.style.backgroundImage = 'none';
                it.style.backgroundColor = 'transparent'
            });
            it.removeAttribute('data-src')
        };

        if (!('IntersectionObserver' in window)) {
            document.querySelectorAll('img').forEach((data) => {
                if (data.getAttribute('data-src')) {
                    loadImg(data)
                }
            });
            return false
        }

        if (window.imageIntersectionObserver) {
            window.imageIntersectionObserver.disconnect();
            document.querySelectorAll('img').forEach(function (data) {
                window.imageIntersectionObserver.observe(data)
            })
        } else {
            window.imageIntersectionObserver = new IntersectionObserver((entries) => {
                entries.forEach((entrie) => {
                    if ((typeof entrie.isIntersecting === 'undefined'
                        ? entrie.intersectionRatio !== 0
                        : entrie.isIntersecting) && entrie.target.getAttribute('data-src')) {
                        loadImg(entrie.target)
                    }
                })
            });
            document.querySelectorAll('img').forEach(function (data) {
                window.imageIntersectionObserver.observe(data)
            })
        }
    };

    //å¤šå›¾ç‰‡æ–‡ä»¶ä¸Šä¼ ï¼ˆæœ¬åœ°ï¼‰
    function upload_img(formData) {
        {#console.log(formData.getAll('files').length);#}
        $.ajax({
            type: 'POST',
            url: '/vditor/img_upload',
            headers: {'X-CSRFToken': getCsrfToken()},
            data: formData,
            dataType: 'JSON',
            contentType: false, //ä¸å¤„ç†æ•°æ®
            processData: false,
            cache: false,
            success: function (data) {
                console.log(data);
                if (data.code === 1) { // ä¸Šä¼ æˆåŠŸï¼Œå°†å›¾ç‰‡é“¾æ¥å†™å…¥ç¼–è¾‘å™¨
                    $.each(data.images, function (i, val) {
                        vditor.focus();
                        let img_url = '\n![](' + val + ')\n';
                        vditor.insertValue(img_url);
                    })
                }
                if (data.code === 0) { //ä¸Šä¼ å¤±è´¥
                    alert(data.msg);
                }
            },
            error: function (data) {
                console.log(data);
            }
        });
    }

</script>
<!--/è¯·åœ¨ä¸Šæ–¹å†™æ­¤é¡µé¢ä¸šåŠ¡ç›¸å…³çš„è„šæœ¬-->
</body>
</html>